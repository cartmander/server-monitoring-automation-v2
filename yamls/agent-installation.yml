trigger: none

parameters:
  - name: scope
    type: string
    default: "Tag"
  - name: subscription
    type: string
  - name: resourceGroup
    type: string
  - name: tagValue
    type: string
  - name: workspaceId
    type: string
  - name: workspaceKey
    type: string

pool: IRRNDG-AUTOMATION-POOL

steps:
  - task: CopyFiles@2
    displayName: 'Copy Run Command Scripts to Virtual Machine'
    inputs:
      sourceFolder: "$(System.DefaultWorkingDirectory)/scripts/run-commands"
      targetFolder: "C:/scripts/AgentInstallationAutomationv2"
      overWrite: true

  - task: AzureCLI@2
    displayName: 'Install Agent on Virtual Machines by Tag'
    inputs:
      azureSubscription: ICO-DEV-SERVICE-CONN
      scriptType: ps
      scriptPath: '$(System.DefaultWorkingDirectory)/scripts/InstallMMAByTagValue.ps1'
      arguments: '-subscription ${{ parameters.subscription }} -resourceGroup ${{ parameters.resourceGroup }} -tagValue ${{ parameters.tagValue }} -workspaceId ${{ parameters.workspaceId }} -workspaceKey ${{ parameters.workspaceKey }}'